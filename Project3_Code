"""
Astroquery Data Retrieval for Sagittarius A* and Star S2 (S0-2)
This module pulls orbital and observational data for modeling the S2 star's orbit around Sgr A*
"""

from astroquery.simbad import Simbad
from astroquery.vizier import Vizier
from astroquery.gaia import Gaia
import pandas as pd
import numpy as np


def get_sagittarius_a_data():
    """
    Retrieve data for Sagittarius A* (Sgr A*), the supermassive black hole at the Galactic Center.
    
    Returns:
    --------
    pandas.DataFrame : SIMBAD data for Sgr A*
    dict : Additional properties extracted from the data
    """
    print("Querying SIMBAD for Sagittarius A*...")
    
    # Customize Simbad to return useful columns
    custom_simbad = Simbad()
    custom_simbad.add_votable_fields('otype', 'sp', 'flux(V)', 'flux(B)', 'plx', 'pm', 'rv', 'z_value')
    
    try:
        # Query Sagittarius A*
        result_table = custom_simbad.query_object("Sagittarius A*")
        
        if result_table is not None and len(result_table) > 0:
            df = result_table.to_pandas()
            
            # Extract key properties
            properties = {
                'name': df['MAIN_ID'].iloc[0] if 'MAIN_ID' in df.columns else 'Sagittarius A*',
                'ra': df['RA'].iloc[0] if 'RA' in df.columns else None,
                'dec': df['DEC'].iloc[0] if 'DEC' in df.columns else None,
                'object_type': df['OTYPE'].iloc[0] if 'OTYPE' in df.columns else None,
            }
            
            print(f"Found data for {properties['name']}")
            return df, properties
        else:
            print("No data found for Sagittarius A*")
            return pd.DataFrame(), {}
            
    except Exception as e:
        print(f"Error querying SIMBAD: {e}")
        return pd.DataFrame(), {}


def get_s2_star_data():
    """
    Retrieve data for star S2 (also known as S0-2), which orbits Sgr A*.
    
    Returns:
    --------
    pandas.DataFrame : SIMBAD data for S2
    dict : Additional properties
    """
    print("Querying SIMBAD for star S2 (S0-2)...")
    
    custom_simbad = Simbad()
    custom_simbad.add_votable_fields('otype', 'sp', 'flux(V)', 'flux(B)', 'plx', 'pm', 'rv', 'z_value')
    
    try:
        # Try different names for S2
        names_to_try = ['S2', 'S0-2', 'S0 2', 'S02', 'Sgr A* S2']
        
        result_table = None
        for name in names_to_try:
            try:
                result_table = custom_simbad.query_object(name)
                if result_table is not None and len(result_table) > 0:
                    print(f"Found S2 using name: {name}")
                    break
            except:
                continue
        
        if result_table is None or len(result_table) == 0:
            # Query by coordinates near Sgr A*
            sgr_a_coords = (266.4168, -29.0078)  # Sgr A* coordinates in degrees
            result_table = custom_simbad.query_region(
                f"{sgr_a_coords[0]} {sgr_a_coords[1]}",
                radius="0d1m0s"  # 1 arcminute radius
            )
        
        if result_table is not None and len(result_table) > 0:
            df = result_table.to_pandas()
            
            # Filter for S2 if multiple results (look for S2 in the name)
            if len(df) > 1:
                s2_mask = df['MAIN_ID'].str.contains('S2|S0-2|S02', case=False, na=False)
                if s2_mask.any():
                    df = df[s2_mask]
            
            properties = {
                'name': df['MAIN_ID'].iloc[0] if 'MAIN_ID' in df.columns else 'S2',
                'ra': df['RA'].iloc[0] if 'RA' in df.columns else None,
                'dec': df['DEC'].iloc[0] if 'DEC' in df.columns else None,
                'spectral_type': df['SP_TYPE'].iloc[0] if 'SP_TYPE' in df.columns else None,
                'proper_motion_ra': df['PMRA'].iloc[0] if 'PMRA' in df.columns else None,
                'proper_motion_dec': df['PMDEC'].iloc[0] if 'PMDEC' in df.columns else None,
                'radial_velocity': df['RV_VALUE'].iloc[0] if 'RV_VALUE' in df.columns else None,
            }
            
            print(f"Found data for {properties['name']}")
            return df, properties
        else:
            print("No data found for S2")
            return pd.DataFrame(), {}
            
    except Exception as e:
        print(f"Error querying SIMBAD: {e}")
        return pd.DataFrame(), {}


def get_s2_orbital_data_from_vizier():
    """
    Query Vizier catalogs for published S2 orbital data and parameters.
    Searches for catalogs containing orbital elements and observational data.
    
    Returns:
    --------
    pandas.DataFrame : Orbital parameters and observational data
    """
    print("Querying Vizier for S2 orbital data...")
    
    # Sgr A* coordinates
    sgr_a_coords = (266.4168, -29.0078)
    
    try:
        v = Vizier(columns=['**'], row_limit=500)
        
        # Search in a small region around Sgr A*
        result_list = v.query_region(
            f"{sgr_a_coords[0]} {sgr_a_coords[1]}",
            radius="0d2m0s",  # 2 arcminute radius
            catalog=["J/ApJ/*", "J/A+A/*", "J/MNRAS/*"]  # Common astronomy journals
        )
        
        if result_list:
            # Combine all results
            all_data = []
            for table in result_list:
                df = table.to_pandas()
                all_data.append(df)
            
            if all_data:
                combined_df = pd.concat(all_data, ignore_index=True)
                print(f"Found {len(combined_df)} records from Vizier")
                return combined_df
        
        return pd.DataFrame()
        
    except Exception as e:
        print(f"Error querying Vizier: {e}")
        return pd.DataFrame()


def get_gaia_data_for_region(ra=266.4168, dec=-29.0078, radius_arcsec=30):
    """
    Query Gaia catalog for stellar data in the region around Sgr A*.
    This can provide proper motions and positions for stars in the region.
    
    Parameters:
    -----------
    ra : float
        Right ascension in degrees
    dec : float
        Declination in degrees
    radius_arcsec : float
        Search radius in arcseconds
        
    Returns:
    --------
    pandas.DataFrame : Gaia catalog data
    """
    print(f"Querying Gaia for stellar data within {radius_arcsec} arcsec of Sgr A*...")
    
    try:
        # Query Gaia DR3
        job = Gaia.launch_job_async(
            f"""
            SELECT TOP 1000
                source_id, ra, dec, 
                parallax, parallax_error,
                pmra, pmra_error, pmdec, pmdec_error,
                phot_g_mean_mag, phot_bp_mean_mag, phot_rp_mean_mag,
                radial_velocity, radial_velocity_error,
                astrometric_excess_noise
            FROM gaiadr3.gaia_source
            WHERE 1=CONTAINS(
                POINT('ICRS', ra, dec),
                CIRCLE('ICRS', {ra}, {dec}, {radius_arcsec/3600.0})
            )
            AND parallax IS NOT NULL
            ORDER BY phot_g_mean_mag
            """
        )
        
        result_table = job.get_results()
        
        if result_table is not None and len(result_table) > 0:
            df = result_table.to_pandas()
            print(f"Found {len(df)} stars in Gaia catalog")
            return df
        else:
            print("No Gaia data found")
            return pd.DataFrame()
            
    except Exception as e:
        print(f"Error querying Gaia: {e}")
        return pd.DataFrame()


def get_galactic_center_stars():
    """
    Query for multiple stars in the Galactic Center region that orbit Sgr A*.
    This includes the S-stars cluster.
    
    Returns:
    --------
    pandas.DataFrame : Data for Galactic Center stars
    """
    print("Querying for Galactic Center stars...")
    
    sgr_a_coords = (266.4168, -29.0078)
    
    try:
        custom_simbad = Simbad()
        custom_simbad.add_votable_fields('otype', 'sp', 'pm', 'rv')
        
        # Query region around Sgr A*
        result_table = custom_simbad.query_region(
            f"{sgr_a_coords[0]} {sgr_a_coords[1]}",
            radius="0d2m0s"  # 2 arcminute radius
        )
        
        if result_table is not None and len(result_table) > 0:
            df = result_table.to_pandas()
            
            # Filter for stars (remove extended sources, galaxies, etc.)
            if 'OTYPE' in df.columns:
                star_mask = ~df['OTYPE'].str.contains('G|Neb|HII|PN', case=False, na=False)
                df = df[star_mask]
            
            print(f"Found {len(df)} stars in the Galactic Center region")
            return df
        else:
            return pd.DataFrame()
            
    except Exception as e:
        print(f"Error querying for Galactic Center stars: {e}")
        return pd.DataFrame()


def compile_all_data():
    """
    Compile all available data for Sgr A* and S2.
    This is the main function to call for getting all relevant data.
    
    Returns:
    --------
    dict : Dictionary containing all retrieved data
    """
    print("=" * 70)
    print("Compiling data for Sagittarius A* and Star S2 (S0-2)")
    print("=" * 70)
    
    all_data = {}
    
    # Get Sgr A* data
    sgr_a_df, sgr_a_props = get_sagittarius_a_data()
    all_data['sgr_a_star'] = sgr_a_df
    all_data['sgr_a_properties'] = sgr_a_props
    
    # Get S2 star data
    s2_df, s2_props = get_s2_star_data()
    all_data['s2_star'] = s2_df
    all_data['s2_properties'] = s2_props
    
    # Get S2 orbital data from Vizier
    s2_orbital = get_s2_orbital_data_from_vizier()
    all_data['s2_orbital_data'] = s2_orbital
    
    # Get Gaia data for the region
    gaia_data = get_gaia_data_for_region()
    all_data['gaia_data'] = gaia_data
    
    # Get other Galactic Center stars
    gc_stars = get_galactic_center_stars()
    all_data['galactic_center_stars'] = gc_stars
    
    print("\n" + "=" * 70)
    print("Data compilation complete!")
    print("=" * 70)
    
    return all_data


def get_s2_orbital_parameters():
    """
    Get published orbital parameters for star S2 (S0-2) around Sagittarius A*.
    These are well-established values from observational studies.
    
    Returns:
    --------
    dict : Dictionary containing all orbital parameters
    """
    # Published orbital parameters for S2 from recent studies
    # Source: GRAVITY Collaboration et al. (2020) and subsequent observations
    # Note: T0 is the most recent pericenter passage (May 2018)
    orbital_params = {
        'a': 0.1255,  # Semi-major axis in arcseconds
        'e': 0.88466,  # Eccentricity (dimensionless)
        'i': 134.567,  # Inclination in degrees
        'Omega': 226.94,  # Longitude of ascending node in degrees
        'omega': 66.32,  # Argument of periapsis in degrees
        'P': 16.0518,  # Orbital period in years
        'T0': 2018.38,  # Time of pericenter passage (year) - May 2018
        'M_bh': 4.154e6,  # Mass of Sgr A* in solar masses
        'distance_gc': 8.178,  # Distance to Galactic Center in kiloparsecs
    }
    
    return orbital_params


def save_data_to_files(data_dict, prefix="sgr_a_s2_data"):
    """
    Save all retrieved data to CSV files.
    
    Parameters:
    -----------
    data_dict : dict
        Dictionary containing dataframes from compile_all_data()
    prefix : str
        Prefix for output filenames
    """
    import os
    
    for key, value in data_dict.items():
        if isinstance(value, pd.DataFrame) and not value.empty:
            filename = f"{prefix}_{key}.csv"
            value.to_csv(filename, index=False)
            print(f"Saved {key} to {filename}")
        elif isinstance(value, dict):
            # Save properties as a simple text file
            filename = f"{prefix}_{key}.txt"
            with open(filename, 'w') as f:
                for k, v in value.items():
                    f.write(f"{k}: {v}\n")
            print(f"Saved {key} to {filename}")


# Example usage and main execution
if __name__ == "__main__":
    print("\n" + "=" * 70)
    print("Sagittarius A* and Star S2 (S0-2) Data Retrieval")
    print("=" * 70 + "\n")
    
    # Compile all data
    data = compile_all_data()
    
    # Display summary
    print("\n" + "=" * 70)
    print("DATA SUMMARY")
    print("=" * 70)
    
    if not data['sgr_a_star'].empty:
        print("\nSagittarius A* Data:")
        print(data['sgr_a_star'][['MAIN_ID', 'RA', 'DEC', 'OTYPE']].to_string())
    
    if not data['s2_star'].empty:
        print("\nS2 Star Data:")
        print(data['s2_star'][['MAIN_ID', 'RA', 'DEC', 'SP_TYPE']].to_string())
    
    if not data['s2_orbital_data'].empty:
        print(f"\nS2 Orbital Data: {len(data['s2_orbital_data'])} records")
        print("Columns:", list(data['s2_orbital_data'].columns))
    
    if not data['gaia_data'].empty:
        print(f"\nGaia Data: {len(data['gaia_data'])} stars")
        print("Sample columns:", list(data['gaia_data'].columns[:10]))
    
    if not data['galactic_center_stars'].empty:
        print(f"\nGalactic Center Stars: {len(data['galactic_center_stars'])} stars")
    
    # Optionally save to files
    # save_data_to_files(data)
    
    print("\n" + "=" * 70)
    print("Data retrieval complete!")
    print("=" * 70)
